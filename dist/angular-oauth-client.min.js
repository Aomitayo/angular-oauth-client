"use strict";angular.module("aomitayo.angular-oauth-client",["ui.router"]),angular.module("aomitayo.angular-oauth-client").factory("Base64",function(){var Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(input){var chr1,chr2,chr3,enc1,enc2,enc3,enc4,output="",i=0;for(input=Base64._utf8_encode(input);i<input.length;)chr1=input.charCodeAt(i++),chr2=input.charCodeAt(i++),chr3=input.charCodeAt(i++),enc1=chr1>>2,enc2=(3&chr1)<<4|chr2>>4,enc3=(15&chr2)<<2|chr3>>6,enc4=63&chr3,isNaN(chr2)?enc3=enc4=64:isNaN(chr3)&&(enc4=64),output=output+this._keyStr.charAt(enc1)+this._keyStr.charAt(enc2)+this._keyStr.charAt(enc3)+this._keyStr.charAt(enc4);return output},decode:function(input){var chr1,chr2,chr3,enc1,enc2,enc3,enc4,output="",i=0;for(input=input.replace(/[^A-Za-z0-9\+\/\=]/g,"");i<input.length;)enc1=this._keyStr.indexOf(input.charAt(i++)),enc2=this._keyStr.indexOf(input.charAt(i++)),enc3=this._keyStr.indexOf(input.charAt(i++)),enc4=this._keyStr.indexOf(input.charAt(i++)),chr1=enc1<<2|enc2>>4,chr2=(15&enc2)<<4|enc3>>2,chr3=(3&enc3)<<6|enc4,output+=String.fromCharCode(chr1),64!=enc3&&(output+=String.fromCharCode(chr2)),64!=enc4&&(output+=String.fromCharCode(chr3));return output=Base64._utf8_decode(output)},_utf8_encode:function(string){string=string.replace(/\r\n/g,"\n");for(var utftext="",n=0;n<string.length;n++){var c=string.charCodeAt(n);128>c?utftext+=String.fromCharCode(c):c>127&&2048>c?(utftext+=String.fromCharCode(c>>6|192),utftext+=String.fromCharCode(63&c|128)):(utftext+=String.fromCharCode(c>>12|224),utftext+=String.fromCharCode(c>>6&63|128),utftext+=String.fromCharCode(63&c|128))}return utftext},_utf8_decode:function(utftext){var c,c1,c2,c3,string="",i=0;for(c=c1=c2=0;i<utftext.length;)c=utftext.charCodeAt(i),128>c?(string+=String.fromCharCode(c),i++):c>191&&224>c?(c2=utftext.charCodeAt(i+1),string+=String.fromCharCode((31&c)<<6|63&c2),i+=2):(c2=utftext.charCodeAt(i+1),c3=utftext.charCodeAt(i+2),string+=String.fromCharCode((15&c)<<12|(63&c2)<<6|63&c3),i+=3);return string}};return Base64}),angular.module("aomitayo.angular-oauth-client").provider("oauth",["$httpProvider",function($httpProvider){function Oauth(provider,$urlMatcherFactory,$rootScope,Base64,$http,$injector){var self=this;self.provider=provider,self.clients=angular.copy(provider.clients),self.$urlMatcherFactory=$urlMatcherFactory,self.$rootScope=$rootScope,self.Base64=Base64,self.$http=$http,self.$injector=$injector,self.sessions=self.provide(self.provider.sessions),angular.forEach(self.clients,function(client,apiRoot){client.sessions=self.provide(client.sessions);var sessions=self.provide(self.sessions||client.sessions),authz=sessions&&sessions.get(self.sessionKey(client));authz&&self.startClient(client,authz,!0),client.urlMatcher=client.urlMatcher||self.$urlMatcherFactory.compile(apiRoot)})}var oauthInstance;return $httpProvider.interceptors.push(function(){return{request:function(config){return oauthInstance?oauthInstance.interceptResourceRequest(config):config}}}),Oauth.prototype={constructor:Oauth,interceptResourceRequest:function(request){var self=this,client=self.apiClient(request.url);return client&&client.tokenEndpoint!=request.url&&client.authz&&client.authz.access_token&&(request.headers.Authorization="Bearer "+client.authz.access_token),request},authorize:function(apiRoot,options){var self=this,client=self.apiClient(apiRoot);if(client){var strategy="authz_"+(options.grant_type||"password");self[strategy](client,options)}},validateAuthz:function(authz){var required_fields={access_token:/.*/,token_type:/.*/},validated=[];return angular.forEach(required_fields,function(rule,k){authz&&authz[k]&&rule.test(authz[k])&&validated.push(k)}),2==validated.length},provide:function(obj){var self=this;return"string"==typeof obj?self.$injector.get(obj):"function"==typeof obj?self.$injector.invoke(obj):angular.isArray(obj)&&"function"==typeof obj[obj.length-1]?self.$injector.invoke(obj):obj},sessionKey:function(client){return"/authz_/"+client.apiRoot},startClient:function(apiRoot,authz,ignoreSessions){var self=this,client=apiRoot&&apiRoot.apiRoot?apiRoot:self.apiClient(apiRoot);if(client&&self.validateAuthz(authz)){if(client.authz=authz,!ignoreSessions){var sessions=self.provide(self.sessions||client.sessions);(sessions||{put:function(){}}).put(self.sessionKey(client),client.authz)}self.$rootScope.$broadcast("Oauth:clientStarted",client)}},stopClient:function(apiRoot){var self=this,client=apiRoot&&apiRoot.apiRoot?apiRoot:self.apiClient(apiRoot);if(client){client.authz=void 0;{self.provide(self.sessions||client.sessions),!0&&(self.provider.sessions||client.sessions||{remove:function(){}}).remove(self.sessionKey(client))}self.$rootScope.$broadcast("Oauth:clientStopped",client)}},apiClient:function(url){var ret,self=this;return angular.forEach(self.clients,function(client,apiRoot){client.urlMatcher=client.urlMatcher||self.$urlMatcherFactory.compile(apiRoot);var match=client.urlMatcher.exec(apiRoot)||0===url.indexOf(apiRoot);match&&(ret=client)}),ret},authz_password:function(client,options){var self=this,headers={"Content-Type":"application/x-www-form-urlencoded"};if(client.credentials){var clientAuth=client.credentials.username+":"+client.credentials.password;clientAuth=self.Base64.encode(clientAuth),headers.Authorization="Basic "+clientAuth}self.$rootScope.$broadcast("Oauth:tokenRequestStart",client),self.$http({method:"POST",url:client.tokenEndpoint,data:{grant_type:"password",username:options.userCredentials.username,password:options.userCredentials.password},headers:headers,transformRequest:function(obj){var str=[];return angular.forEach(obj,function(v,k){str.push(encodeURIComponent(k)+"="+encodeURIComponent(v))}),str.join("&")}}).success(function(response){var authz={access_token:response.access_token,token_type:response.token_type,expires_in:response.expires_in,refresh_token:response.refresh_token,scope:response.scope};self.$rootScope.$broadcast("Oauth:tokenRequestSuccess",client),self.startClient(client,authz)}).error(function(data){var err=data.error_description||data.error||data;self.$rootScope.$broadcast("Oauth:tokenRequestError",client,err)})}},{clients:{},sessions:!1,useSessions:function(store){return this.sessions=store,this},client:function(apiRoot,config){var client=angular.copy(config);return client.apiRoot=apiRoot,this.clients[apiRoot]=client,this},$get:["$urlMatcherFactory","$rootScope","Base64","$http","$injector",function($urlMatcherFactory,$rootScope,Base64,$http,$injector){return oauthInstance=oauthInstance||new Oauth(this,$urlMatcherFactory,$rootScope,Base64,$http,$injector)}]}}]);